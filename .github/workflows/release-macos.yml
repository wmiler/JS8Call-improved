name: Build and Release for MacOS 15 Arm64 (M1 and higher)

on: 
  workflow_dispatch:
  pull_request:
  release:
    types: [published]
    
env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build_macos-latest:
    runs-on: macos-15
    permissions: write-all
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Work around for /usr/local perms and grab arch/os info
      run: |
        sudo chown runner:admin /usr/local
        arch
        sw_vers
      
    - name: Release AC9KH package
      uses: robinraju/release-downloader@v1.12
      with:
        repository: 'Chris-AC9KH/js8lib'
        fileName: 'js8lib-2.3_Darwin_arm64_Qt6.9.3.tar.gz'
        latest: true
        extract: true
        out-file-path: '/usr/local/'

    - name: Look for and delete files that break app building
      run: |
        find /usr/local/js8lib -type f -name ._* -delete
      continue-on-error: true

    - name: Build JS8Call and tar.gz the app
      run: |
        mkdir -p ./build && cd ./build
        cmake -DCMAKE_PREFIX_PATH="/usr/local/js8lib" ..
        make
        tar zcf ../js8call-improved_2.4.1-devel_arm64_macos15.app.tar.gz JS8Call-improved.app

    - name: Upload Artifact (app)
      uses: actions/upload-artifact@v5
      with:
        name: js8call-improved_2.4.1-devel_arm64_macos15.app
        path: /Users/runner/work/JS8Call-improved/JS8Call-improved/build/

  release:
    runs-on: ubuntu-24.04
    permissions: write-all
    needs: build_macos-latest
    steps: 
    # Needed to get the git commit history. Run a regular checkout on the prime repo
    #    - uses: actions/checkout@v5
        - run: git clone https://github.com/Chris-AC9KH/JS8Call-improved.git

        - uses: actions/download-artifact@v4
          with:
            name: js8call-improved_2.4.1-devel_arm64_macos15.app
            path: js8call
            
        - run: |
            zip -r js8call-improved_2.4.1-devel_arm64_macos15.app.zip js8call/JS8Call-improved.app
            tar zcf js8call-improved_2.4.1-devel_arm64_macos15.app.tar.gz js8call/JS8Call-improved.app

        - name: Create Changelog
          id: github_release
          uses: mikepenz/release-changelog-builder-action@v6
          with:
            mode: "COMMIT"
            fromTag: "02070ccfc3c2133e85cca4f4220a9ced161db15b"
            configurationJson: |
              {
                "template": "#{{CHANGELOG}}",
                "categories": [
                  {
                      "title": "## Feature",
                      "labels": ["feat", "feature"]
                  },
                  {
                      "title": "## Fix",
                      "labels": ["fix", "bug"]
                  },
                  {
                      "title": "## Docs",
                      "labels": ["documentation"]
                  },
                  {
                     "title": "## Other",
                     "labels": []
                  }
                ],
                "label_extractor": [
                  {
                    "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test){1}(\\([\\w\\-\\.]+\\))?(!)?: ([\\w ])+([\\s\\S]*)",
                    "on_property": "title",
                    "target": "$1"
                  }
                ]
              }
          continue-on-error: true
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        - uses: softprops/action-gh-release@v2.4.2
          with:
            tag_name: js8call-improved-arm64_macos15-v2.4.1-devel
            name: "JS8Call-Improved Release for MacOS 15"
            body: |
              This is a release of JS8Call-Improved for MacOS 15 (M1+ cpus).
              ${{steps.github_release.outputs.changelog}}
            files: |
              js8call-improved_2.4.1-devel_arm64_macos15.app.zip
              js8call-improved_2.4.1-devel_arm64_macos15.app.tar.gz
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
